$NetBSD$

--- src/DiskIO/DiskDaemon/diskd.cc.orig	2010-08-01 14:01:39.000000000 +0000
+++ src/DiskIO/DiskDaemon/diskd.cc
@@ -39,6 +39,20 @@
 #include <sys/msg.h>
 #include <sys/shm.h>
 
+#ifdef __QNX__
+#include <mqueue.h>
+
+char *toKeyString(unsigned int key)
+{
+        int size = snprintf(NULL, 0, "/0x%08x", key);
+        if(size < 0)
+                return NULL;
+        char *ret = new char[size+1];
+        snprintf(ret, size+1, "/0x%08x", key);
+        return ret;
+}
+#endif
+
 #include "DiskIO/DiskDaemon/diomsg.h"
 
 void
@@ -313,12 +327,21 @@ int
 main(int argc, char *argv[])
 {
     int key;
+#ifdef __QNX__
+    mqd_t rmsgid;
+    mqd_t smsgid;
+#else
     int rmsgid;
     int smsgid;
+#endif
     int shmid;
     diomsg rmsg;
     diomsg smsg;
+#ifdef __QNX__
+    mqd_t rlen;
+#else
     int rlen;
+#endif
     char rbuf[512];
 
     struct sigaction sa;
@@ -327,7 +350,14 @@ main(int argc, char *argv[])
     mypid = getpid();
     assert(4 == argc);
     key = atoi(argv[1]);
+
+#ifdef __QNX__
+    char* name = toKeyString(key);
+    rmsgid = mq_open(name, O_RDWR | O_CREAT | O_NONBLOCK, 0700, NULL);
+    delete[]name;
+#else
     rmsgid = msgget(key, 0600);
+#endif
 
     if (rmsgid < 0) {
         perror("msgget");
@@ -335,8 +365,13 @@ main(int argc, char *argv[])
     }
 
     key = atoi(argv[2]);
+#ifdef __QNX__
+    name = toKeyString(key);
+    smsgid = mq_open(name, O_RDWR | O_CREAT | O_NONBLOCK, 0700, NULL);
+    delete[]name;
+#else
     smsgid = msgget(key, 0600);
-
+#endif
     if (smsgid < 0) {
         perror("msgget");
         return 1;
@@ -372,8 +407,12 @@ main(int argc, char *argv[])
         std::cerr << "msgrcv: " << rmsgid << ", "
                   << &rmsg << ", " << diomsg::msg_snd_rcv_sz
                   << ", " << 0 << ", " << 0 << std::endl;
+ 
+#ifdef __QNX__
+	rlen = mq_receive(rmsgid, (char*)&rmsg, diomsg::msg_snd_rcv_sz, NULL);	
+#else
         rlen = msgrcv(rmsgid, &rmsg, diomsg::msg_snd_rcv_sz, 0, 0);
-
+#endif
         if (rlen < 0) {
             if (EINTR == errno) {
                 if (read(0, rbuf, 512) <= 0) {
@@ -397,20 +436,32 @@ main(int argc, char *argv[])
         alarm(0);
         msg_handle(&rmsg, rlen, &smsg);
 
+#ifdef __QNX__
+        if (mq_send(smsgid, (char*)&smsg, diomsg::msg_snd_rcv_sz, 1) < 0) {
+            perror("mq_send");
+            break;
+        }
+#else
         if (msgsnd(smsgid, &smsg, diomsg::msg_snd_rcv_sz, 0) < 0) {
             perror("msgsnd");
             break;
         }
+#endif
     }
 
     DEBUG(2)
     fprintf(stderr, "%d diskd exiting\n", (int) mypid);
 
+#ifdef __QNX__
+    mq_close(rmsgid);
+    mq_close(smsgid);
+#else
     if (msgctl(rmsgid, IPC_RMID, 0) < 0)
         perror("msgctl IPC_RMID");
 
     if (msgctl(smsgid, IPC_RMID, 0) < 0)
         perror("msgctl IPC_RMID");
+#endif
 
     if (shmdt(shmbuf) < 0)
         perror("shmdt");
