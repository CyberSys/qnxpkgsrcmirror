$NetBSD$

--- src/DiskIO/DiskDaemon/DiskdIOStrategy.cc.orig	2010-03-29 10:02:56.000000000 +0000
+++ src/DiskIO/DiskDaemon/DiskdIOStrategy.cc
@@ -47,6 +47,21 @@
 #include "Store.h"
 #include "SquidTime.h"
 
+#ifdef __QNX__
+#include <mqueue.h>
+
+char *toKeyString(unsigned int key)
+{
+	int size = snprintf(NULL, 0, "/0x%08x", key);
+	if(size < 0)
+		return NULL;
+	char *ret = new char[size+1];
+	snprintf(ret, size+1, "/0x%08x", key);
+	return ret;	
+}
+
+#endif
+
 diskd_stats_t diskd_stats;
 
 size_t DiskdIOStrategy::nextInstanceID (0);
@@ -161,6 +176,30 @@ DiskdIOStrategy::init()
 
     ikey = (getpid() << 10) + (instanceID << 2);
     ikey &= 0x7fffffff;
+#ifdef __QNX__
+    char* name = toKeyString(ikey);
+    if(!name) {
+        debugs(50, 0, "storeDiskdInit: keyToString: could not create key string.");
+        fatal("keyToString failed");
+    }
+
+    smsgid = mq_open(name, O_RDWR | O_CREAT | O_NONBLOCK, 0700, NULL);
+    if(smsgid < 0) {
+        debugs(50, 0, "storeDiskdInit: mq_open: " << xstrerror());
+        fatal("mq_open failed");
+    }
+
+    delete[]name;
+
+    name = toKeyString(ikey+1);
+    rmsgid = mq_open(name, O_RDWR | O_CREAT | O_NONBLOCK, 0700, NULL);
+    if(rmsgid < 0) {
+        debugs(50, 0, "storeDiskdInit: mq_open: " << xstrerror());
+        fatal("mq_open failed");
+    }
+
+    delete[]name; 
+#else
     smsgid = msgget((key_t) ikey, 0700 | IPC_CREAT);
 
     if (smsgid < 0) {
@@ -174,7 +213,7 @@ DiskdIOStrategy::init()
         debugs(50, 0, "storeDiskdInit: msgget: " << xstrerror());
         fatal("msgget failed");
     }
-
+#endif
     shm.init(ikey, magic2);
     snprintf(skey1, 32, "%d", ikey);
     snprintf(skey2, 32, "%d", ikey + 1);
@@ -376,7 +415,12 @@ DiskdIOStrategy::SEND(diomsg *M, int mty
     static int send_errors = 0;
     static int last_seq_no = 0;
     static int seq_no = 0;
+
+#ifdef __QNX__
+    mqd_t x;
+#else
     int x;
+#endif
 
     M->mtype = mtype;
     M->size = size;
@@ -388,9 +432,11 @@ DiskdIOStrategy::SEND(diomsg *M, int mty
 
     if (M->seq_no < last_seq_no)
         debugs(79, 1, "WARNING: sequencing out of order");
-
+#ifdef __QNX__
+    x = mq_send(smsgid, (char*)M, diomsg::msg_snd_rcv_sz, 1);    
+#else
     x = msgsnd(smsgid, M, diomsg::msg_snd_rcv_sz, IPC_NOWAIT);
-
+#endif
     last_seq_no = M->seq_no;
 
     if (0 == x) {
@@ -539,7 +585,11 @@ int
 DiskdIOStrategy::callback()
 {
     diomsg M;
+#ifdef __QNX__
+    mqd_t x;
+#else
     int x;
+#endif
     int retval = 0;
 
     if (away >= magic2) {
@@ -559,8 +609,11 @@ DiskdIOStrategy::callback()
         memset(&M, '\0', sizeof(M));
 #endif
 
+#ifdef __QNX__
+        x = mq_receive(rmsgid, (char*)&M, diomsg::msg_snd_rcv_sz, NULL);
+#else
         x = msgrcv(rmsgid, &M, diomsg::msg_snd_rcv_sz, 0, IPC_NOWAIT);
-
+#endif
         if (x < 0)
             break;
         else if (x != diomsg::msg_snd_rcv_sz) {
